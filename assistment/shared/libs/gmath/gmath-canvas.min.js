/// Copyright Erik Weitnauer 2015.
gmath.ui=gmath.ui||{};gmath.ui.Path=function(){var e=function(e,t){this.container=d3.select(e);this.element=null;t=t||{};this.id=gmath.uid();this.oid=t.oid;this.points=t.points||[];this.color=t.color||"black";this.width=t.width||1;this.type=t.type;this.init()};e.line=typeof d3==="undefined"||typeof d3.svg==="undefined"?null:d3.svg.line();e.prototype.init=function(){var e=null;if(this.oid)e="#"+this.oid;this.element=this.container.insert("path",e).attr("id",this.id).style("fill","none").style("stroke-linecap","round").style("stroke-linejoin","round");return this.update()};e.prototype.update=function(){this.element.attr("d",e.line(this.points)+(this.points.length===1?"Z":"")).style("stroke",this.color).style("stroke-width",this.width);return this};e.prototype.remove=function(){this.element.remove();return this};e.prototype.setContainer=function(e){if(arguments.length===0)return this.container;this.container=e;return this};e.prototype.renderOnto=function(e){var t=this.element,n=this.container;this.container=e;this.element=e.select("#"+this.id);if(this.element.empty())this.init();else this.update();this.container=n;this.element=t};return e}();gm_erase_paths=function(){function e(e,t,n){n=n||20;var r=[];var i=function(e){var i=t[0][0];var o=t[0][1];var a=0;var l=0;if(e.length===1){if(!s(e[0][0],e[0][1],i,o,n)){r.push(e);return}}var u;while(a<e.length-1){var h=e[a];var f=e[a+1];var d=s(h[0],h[1],i,o,n);var g=s(f[0],f[1],i,o,n);if(d&&g){a++;l=a}else if(d&&!g){var v=p(h[0],h[1],f[0],f[1],i,o,n);if(v){e[a]=v;l=a}else{a++}}else if(!d&&g){var v=p(f[0],f[1],h[0],h[1],i,o,n);if(v){u=e.slice(l,a+1);u.push(v);r.push(u)}a++;l=a}else{var y=c(h[0],h[1],f[0],f[1],i,o,n);if(y){u=e.slice(l,a+1);if(u[u.length-1][0]!==y[0][0]||u[u.length-1][1]!==y[0][1]){u.push(y[0])}if(u.length>1)r.push(u);e[a]=y[1];if(e[a+1]&&e[a+1][0]==y[1][0]&&e[a+1][1]==y[1][1])a++;l=a}else{a++}}}if(l!==a){u=e.slice(l,e.length);if(u){r.push(u)}}};var a=function(e,i){if(e.path){n=n+e.width/2;var e=e.path}var o=t[i];var a=t[i+1];var i=0;var s=0;if(e.length===1){var l=u(e[0][0],e[0][1],o[0],o[1],a[0],a[1],n);if(l.indexOf(1)===-1){r.push(e);return}}var h;while(i<e.length-1){var p=e[i];var c=e[i+1];var l=u(p[0],p[1],o[0],o[1],a[0],a[1],n);var f=u(c[0],c[1],o[0],o[1],a[0],a[1],n);if(l.indexOf(1)!==-1&&f.indexOf(1)!==-1){i++;s=i}else if(l.indexOf(1)!==-1&&f.indexOf(1)===-1){var v=d(p[0],p[1],l,c[0],c[1],o[0],o[1],a[0],a[1],n);if(v){e[i]=v;s=i}else{i++}}else if(l.indexOf(1)===-1&&f.indexOf(1)!==-1){var v=d(c[0],c[1],f,p[0],p[1],o[0],o[1],a[0],a[1],n);if(v){h=e.slice(s,i+1);h.push(v);r.push(h);i++;s=i}else{i++}}else{var y=g(p[0],p[1],c[0],c[1],o[0],o[1],a[0],a[1],n);if(y){h=e.slice(s,i+1);if(h[h.length-1][0]!==y[0][0]||h[h.length-1][1]!==y[0][1]){h.push(y[0])}if(h.length>1)r.push(h);e[i]=y[1];if(e[i+1]&&e[i+1][0]==y[1][0]&&e[i+1][1]==y[1][1])i++;s=i}else{i++}}}if(s!==i){h=e.slice(s,e.length);if(h){r.push(h)}}};t=o({path:t});if(t.length===1){for(var l=0;l<e.length;l++){i(e[l])}e=r}else{for(var h=0;h<t.length-1;h++){for(var l=0;l<e.length;l++){a(e[l],h)}e=r;r=[]}}for(var f=0;f<e.length;f++){for(var v=0;v<e[f].length;v++){e[f][v][0]=Math.round(e[f][v][0]);e[f][v][1]=Math.round(e[f][v][1])}}return e}function t(e){if(e.path){var e=e.path}document.write("[");for(var t=0;t<e.length-1;t++){document.write("["+e[t][0]+","+e[t][1]+"],")}document.write("["+e[t][0]+","+e[t][1]+"]");document.write("]")}function n(e){document.write("[");for(var n=0;n<e.length-1;n++){t(e[n]);document.write(",<br />")}t(e[n]);document.write("]")}function r(e,t){if(e.path){var e=e.path}var n="";n+="[";for(var r=0;r<e.length-1;r++){n+="["+e[r][0]+","+e[r][1]+"],"}n+="["+e[r][0]+","+e[r][1]+"]";n+="]";if(t){console.log(n)}else{return n}}function i(e){log="";log+="[";for(var t=0;t<e.length-1;t++){log+=r(e[t],0);log+=","}log+=r(e[t],0);log+="]";console.log(log)}function o(e){if(e.path){var e=e.path}var t=[];if(e.length===1){t=e}else{pClean=0;while(pClean<e.length-1){if(e[pClean][0]!==e[pClean+1][0]||e[pClean][1]!==e[pClean+1][1]){t.push(e[pClean])}pClean++}if(e.length!==0&&t.length===0){t.push(e[0])}if(e[e.length-1][0]!==e[t.length-1][0]||e[e.length-1][1]!==e[t.length-1][1]){t.push(e[pClean])}}return t}function a(e,t,n,r){return Math.sqrt(Math.pow(n-e,2)+Math.pow(r-t,2))}function s(e,t,n,r,i){var o=a(e,t,n,r);if(o<i)return 1;else return 0}function l(e,t,n,r,i,o,a){var s=[i-n,o-r];var l=[e-n,t-r];var u=[-s[1],s[0]];var h=Math.sqrt(Math.pow(u[0],2)+Math.pow(u[1],2));var p=[u[0]/h,u[1]/h];var c=Math.sqrt(Math.pow(s[0],2)+Math.pow(s[1],2));var f=[s[0]/c,s[1]/c];var d=l[0]*f[0]+l[1]*f[1];if(d<=0||d>=c)return 0;var g=l[0]*p[0]+l[1]*p[1];if(g>=a||g<=-a)return 0;return 1}function u(e,t,n,r,i,o,a){var u=[];u.push(s(e,t,n,r,a));u.push(s(e,t,i,o,a));u.push(l(e,t,n,r,i,o,a));return u}function h(e,t,n,r,i){var o=[n-e,r-t];var a=[-o[1],o[0]];var s=Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2));var l=[a[0]/s,a[1]/s];var u=[e+i*l[0],t+i*l[1]];var h=[e-i*l[0],t-i*l[1]];var p=[n-i*l[0],r-i*l[1]];var c=[n+i*l[0],r+i*l[1]];return[u,h,p,c]}function p(e,t,n,r,i,o,a){var s=[i-e,o-t];var l=[n-e,r-t];var u=Math.sqrt(Math.pow(l[0],2)+Math.pow(l[1],2));var h=[l[0]/u,l[1]/u];var p=s[0]*h[0]+s[1]*h[1];var c=[e+p*h[0],t+p*h[1]];var f=Math.sqrt(Math.pow(i-c[0],2)+Math.pow(o-c[1],2));var d;if(f===0){d=a}else{var d=Math.sqrt(Math.pow(a,2)-Math.pow(f,2))}var g=[e+p*h[0]+d*h[0],t+p*h[1]+d*h[1]];if(g[0]===e&&g[1]===t)return null;return g}function c(e,t,n,r,i,o,a){var s=[i-e,o-t];var l=[n-e,r-t];var u=[-l[1],l[0]];var h=Math.sqrt(Math.pow(u[0],2)+Math.pow(u[1],2));var p=[u[0]/h,u[1]/h];var c=s[0]*p[0]+s[1]*p[1];var f=m([e,t],[n,r],[i,o]);var d=v([f[0]-i,f[1]-o]);if(d>=a)return null;var g=Math.sqrt(Math.pow(a,2)-Math.pow(c,2));var y=[i-c*p[0],o-c*p[1]];var w=Math.sqrt(Math.pow(l[0],2)+Math.pow(l[1],2));var b=[l[0]/w,l[1]/w];var _=[[y[0]-b[0]*g,y[1]-b[1]*g],[y[0]+b[0]*g,y[1]+b[1]*g]];if(_[0][0]===e&&_[0][1]===t)return null;return _}function f(e,t,n,r,i,o,a,s){var l,u,h,p;l=n-e;u=r-t;h=a-i;p=s-o;var c,f;if(-h*u+l*p===0)return null;c=(-u*(e-i)+l*(t-o))/(-h*u+l*p);f=(h*(t-o)-p*(e-i))/(-h*u+l*p);if(c>=0&&c<=1&&f>=0&&f<=1){var d=e+f*l;var g=t+f*u;return[d,g]}return null}function d(e,t,n,r,i,o,s,l,u,d){var g=h(o,s,l,u,d);var v=[];if(n[0]&&!n[1]){v.push(p(e,t,r,i,o,s,d));v.push(f(e,t,r,i,g[0][0],g[0][1],g[3][0],g[3][1]));v.push(f(e,t,r,i,g[1][0],g[1][1],g[2][0],g[2][1]));var y=c(e,t,r,i,l,u,d);if(y)v.push(y[0],y[1])}else if(!n[0]&&n[1]){v.push(p(e,t,r,i,l,u,d));v.push(f(e,t,r,i,g[0][0],g[0][1],g[3][0],g[3][1]));v.push(f(e,t,r,i,g[1][0],g[1][1],g[2][0],g[2][1]));var y=c(e,t,r,i,o,s,d);if(y)v.push(y[0],y[1])}else if(n[0]&&n[1]){v.push(p(e,t,r,i,o,s,d));v.push(f(e,t,r,i,g[0][0],g[0][1],g[3][0],g[3][1]));v.push(f(e,t,r,i,g[1][0],g[1][1],g[2][0],g[2][1]));v.push(p(e,t,r,i,l,u,d))}else{var y=c(e,t,r,i,l,u,d);var m=c(e,t,r,i,o,s,d);if(y)v.push(y[0],y[1]);if(m)v.push(m[0],m[1]);v.push(f(e,t,r,i,g[0][0],g[0][1],g[3][0],g[3][1]));v.push(f(e,t,r,i,g[1][0],g[1][1],g[2][0],g[2][1]))}var w=[e,t];for(var b=0;b<v.length;b++){if(v[b]){if(a(v[b][0],v[b][1],r,i)<a(w[0],w[1],r,i)){w=v[b]}}}if(w[0]===e&&w[1]===t)return null;return w}function g(e,t,n,r,i,o,s,l,u){var p=h(i,o,s,l,u);var d=[];var g=c(e,t,n,r,i,o,u);if(g)d.push(g[0],g[1]);g=c(e,t,n,r,s,l,u);if(g)d.push(g[0],g[1]);d.push(f(e,t,n,r,p[0][0],p[0][1],p[3][0],p[3][1]));d.push(f(e,t,n,r,p[1][0],p[1][1],p[2][0],p[2][1]));var v=[n,r];var y=[e,t];for(var m=0;m<d.length;m++){if(d[m]){if(a(d[m][0],d[m][1],e,t)<a(v[0],v[1],e,t)){v=d[m]}}}for(var w=0;w<d.length;w++){if(d[w]){if(a(d[w][0],d[w][1],n,r)<a(y[0],y[1],n,r)){y=d[w]}}}if(v[0]===n&&v[1]===r||y[0]===e&&y[1]===t)return null;else return[v,y]}var v=function(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])};var y=1e-6;var m=function(e,t,n){var r=[t[0]-e[0],t[1]-e[1]],i=v(r);if(i<y)return e;var o=[n[0]-e[0],n[1]-e[1]];var a=(r[0]*o[0]+r[1]*o[1])/i;if(a<0)return e;if(a>i)return t;return[e[0]+r[0]*a/i,e[1]+r[1]*a/i]};if(typeof exports!="undefined"){exports.erase=e}return e}();gm_hwr_request=function(){var e=function(e){var t={type:"stroke",x:[],y:[]};e.points.forEach(function(e){t.x.push(e[0]);t.y.push(e[1])});return t};var t=function(t,n){url="http://dlandy.psych.indiana.edu:7031/server.js";var r={components:t.map(e),resultTypes:["LATEX"]};var i={apiKey:"c26d2755-1fda-4033-b136-4af042f3f9db",equationInput:JSON.stringify(r)};var o=$.post(url,i.equationInput);o.done(function(e){var t=e.replace(/\\/g,"\\\\");t=JSON.parse(t);n(null,t.JSON)})};return t}();gmath.ui=gmath.ui||{};gmath.ui.holdUI=function(){var e=function(e,t,n){this.container=e;this.controller=t;this.view=n;this.element=null;this.pos=[0,0];this.visible=false;this.buttons=[];this.button_els=null;this.colors=d3.scale.category10();this.button_rads=null;this.inner_radius=20;this.outer_radius=80;this.init()};e.prototype.setPos=function(e){this.pos=e;this.element.attr("transform","translate("+e[0]+","+e[1]+")")};e.prototype.setVisible=function(e){this.visible=e;this.element.style("display",e?null:"none")};e.prototype.init=function(){var e=this,t={stroke:"black","stroke-width":1,"stroke-linecap":"round",fill:"none"};this.buttons.push({action:function(t){e.controller.inputDL(t)},icon:function(e){var t=e.append("g").attr("transform","translate(0,10)").append("g");var n=new gmath.AlgebraModel("f_x",{});var r=new gmath.AlgebraView(n,t,{font_size:"35",inactive_color:"black",interactive:false});r.init();return t},color:e.colors(0)});this.buttons.push({action:function(t){var n={pos:{x:t[0],y:t[1]}};e.view.createGraph(n)},icon:function(e){var n=e.append("g").attr("transform","translate(2,0)").style("cursor","pointer");var r=n.append("g").style("opacity",.5).style("shape-rendering","crispedges");r.append("line").attr({x1:-15,y1:0,x2:15,y2:0}).style(t);r.append("line").attr({x1:0,y1:-15,x2:0,y2:15}).style(t);r.append("rect").attr({x:-15,y:-15,width:30,height:30}).style(t);n.append("line").attr({x1:-15,y1:8,x2:15,y2:-8}).style(t).style("stroke-width",1.5);return n},color:e.colors(1)});this.buttons.push({action:function(t){var n={pos:{x:t[0],y:t[1]},closable:true};e.view.createMessage(n)},icon:function(e){var n=e.append("g");var r=n.append("g").style("opacity",.5);r.append("text").text("Aa").attr({x:0,y:10}).attr("text-anchor","middle").attr("font-size",30).style(t).style("fill","black").style("pointer-events","none");return n},color:e.colors(2)});this.button_rads=Math.PI*2/this.buttons.length;var n=this.button_rads,r=this.inner_radius,i=this.outer_radius;this.element=this.container.append("g");var o=this.element.append("defs"),a=o.append("filter").attr("id","dropShadow_holdUI");a.append("feGaussianBlur").attr("in","SourceAlpha").attr("stdDeviation",3);a.append("feOffset").attr("dx",0).attr("dy",4).attr("result","offsetblur");a.append("feComponentTransfer").append("feFuncA").attr("type","linear").attr("slope",.25);var s=a.append("feMerge");s.append("feMergeNode");s.append("feMergeNode").attr("in","SourceGraphic");this.element.attr("filter","url(#dropShadow_holdUI)");this.button_els=this.element.selectAll(".holdUI").data(this.buttons);this.button_els.enter().append("g").classed("holdUI",true).append("path").attr("d",function(e,t){var o=Math.cos(n*t)*r,a=-Math.sin(n*t)*r,s=Math.cos(n*t)*i,l=-Math.sin(n*t)*i,u=Math.cos(n*(t+1))*i,h=-Math.sin(n*(t+1))*i,p=Math.cos(n*(t+1))*r,c=-Math.sin(n*(t+1))*r;return"M"+o+","+a+"L"+s+","+l+"A"+i+","+i+" 0 0,0 "+u+","+h+"L"+p+","+c+"A"+r+","+r+" 0 0,1 "+o+","+a+"Z"}).style("fill",function(e){return e.color}).style("opacity",.8).style("cursor","pointer");this.button_els.each(function(e,t){var o=d3.select(this),a=e.icon(o);a.attr("transform",function(){var e=Math.cos(n*(t+.5))*(r+(i-r)/2),o=-Math.sin(n*(t+.5))*(r+(i-r)/2);return"translate("+e+", "+o+")"})})};e.prototype.detectHit=function(e){var t=this,n=this.button_rads,r=this.inner_radius,i=this.outer_radius,o=-1;this.button_els.each(function(a,s){var l=Math.sqrt(Math.pow(e[0]-t.pos[0],2)+Math.pow(e[1]-t.pos[1],2)),u=Math.atan2(-e[1]+t.pos[1],e[0]-t.pos[0]);if(u<0)u+=Math.PI*2;if(l>r&&l<i&&u>n*s&&u<n*(s+1))o=s});return o};e.prototype.highlight=function(e){var t=this.detectHit(e);this.button_els.each(function(e,n){var r=d3.select(this).select("path");if(t===n)r.transition().duration(30).style("fill",d3.rgb(e.color).brighter(.6));else r.transition().duration(30).style("fill",e.color)})};e.prototype.performAction=function(e){var t=this.detectHit(e);this.button_els.each(function(n,r){if(r===t)n.action(e)})};return e}();gmath.ui=gmath.ui||{};gmath.ui.CanvasController=function(){var e=function(e){var t=d3.dispatch("scroll","start_hwr","stop_hwr","undone","redone","hold","touch","drag","release","font_size","keyboard","entered_term");var n=gmath.uid(),r=e,i=null,o=false,a="math",s=true,l,u=1500,h=null,p=r.paths().length,c=2,f=50,d=null,g="black",v=null,y=null,m=0,w=null,b=null,_=false,k=[],x=-1,M=false,C=null,q=false,z=true,D=true;function P(e){if(M){M=false;return}x+=1;k[x]=e;k.length=x+1}var L=function(){e.on("create."+n,function(e){if(e.target_type==="dl"){var t=e.target;P({type:"create_dl",dl:t});t.events.on("added_line."+n,function(){if(t.rows.length>1){P({type:"math",dl:t})}})}});C=new gmath.ui.holdUI(r.container(),L,r);C.setVisible(false);I(e.container().select("#background_event_layer"),G());I(e.container().select("#foreground_event_layer"),W());e.on("mode."+n,function(e){if(e.mode==="draw"||e.mode==="erase"){r.display_foreground_event_layer(true)}else{r.display_foreground_event_layer(false)}});if(z&&typeof gmath.ui.Keyboard!=="undefined"&&typeof $!=="undefined"){i=gmath.ui.Keyboard();i.width(800).position("center").on("done",Q).on("cancel",ee)()}r.container().on("dragover",function(){d3.event.preventDefault()}).on("drop",te);r.on("mode",function(e){E(e.mode)});return this};var E=function(e){if(e==="transform"||e==="inspect"||e==="delete")L.mode("math");else if(e==="draw")L.mode("draw");else if(e==="erase")L.mode("erase");else throw"Unkown CanvasModel mode: '"+e+"'"};L.id=n;L.model=function(){if(arguments.length===0)return r};L.mode=function(e){if(arguments.length===0)return a;a=e;return this};L.use_keyboard=function(e){if(arguments.length===0)return z;z=e;return this};L.use_hold_menu=function(e){if(arguments.length===0)return D;D=e;return this};L.color=function(e){if(arguments.length===0)return g;g=e;return this};L.markerRadius=function(e){if(arguments.length===0)return c;c=e;return this};L.eraserRadius=function(e){if(arguments.length===0)return f;f=e;return this};L.hwr_delay=function(e){if(arguments.length===0)return u;u=e;return this};L.tx_behavior=function(){return y};L.hwr=function(e){if(!arguments.length)return s;if(s===e)return L;s=e;p=r.paths.length;if(!s)L.cancelHWR();return L};L.drawing=function(e){if(!arguments.length)return l;l=e;return this};L.scheduleHWR=function(){if(!h){h=setTimeout(L.performHWR,u);t.start_hwr()}};L.cancelHWR=function(e){if(!e)p=r.paths.length;if(h){clearTimeout(h);h=null;t.stop_hwr()}};L.performHWR=function(){h=null;t.stop_hwr();if(p>r.paths().length-1)return;var e=r.paths().slice(p),n=false,i=[];gm_hwr_request(e,function(t,o){if(t)console.log(t);var a=e[0].points[0];try{n=r.createDL({pos:a,eq:o})}catch(s){return}var l=function(e){try{r.removePath(e);i.push(e)}catch(t){return}};for(var u=0;u<e.length;u++){l(e[u])}p=r.paths().length;if(n&&i.length>0){P({type:"convert",removed_paths:i,added_dl:n})}});p=r.paths().length};L.scroll=function(e){if(arguments.length===0)return m;m=Math.min(0,e);y.transform({translate:[0,m]});r.paths_container().attr("transform","translate(0,"+m+")");r.dls_container().attr("transform","translate(0,"+m+")");t.scroll(m);return this};L.clear_undo_queue=function(){x=-1;k=[]};L.undo=function(){if(x===-1)return;var e=k[x];console.log("undo",e.type);x--;if(e.type==="draw"){r.removePath(e.path)}else if(e.type==="erase"){e.removed.forEach(function(e){r.addPath(e)});e.added.forEach(function(e){r.removePath(e)});e.modified.forEach(function(e){e.path.points=e.points_before;r.updatePath(e.path)})}else if(e.type==="convert"){e.removed_paths.forEach(function(e){r.addPath(e)});this.undo()}else if(e.type==="math"){var n=e.dl.undo();e.undone_row=n.last_row;e.removed_links=n.dead_links}else if(e.type==="create_dl"){r.removeDL(e.dl);e.removed_links=gmath.LinkCoordinator.unlinkDL(e.dl)}t.undone({type:"undone",action:e})};L.redo=function(){if(k.length<=x+1)return;x+=1;var e=k[x];console.log("redo",e.type);if(e.type==="draw"){r.addPath(e.path)}else if(e.type==="erase"){e.removed.forEach(function(e){r.removePath(e)});e.modified.forEach(function(e){e.path.points=e.points_after;r.updatePath(e.path)});e.added.forEach(function(e){r.addPath(e)})}else if(e.type==="convert"){e.removed_paths.forEach(function(e){r.removePath(e)})}else if(e.type=="math"){M=true;e.dl.redo(e)}else if(e.type=="create_dl"){M=true;r.addDL(e.dl);gmath.LinkCoordinator.addLinks(e.removed_links)}t.redone({type:"redone",action:e})};L.font_smaller=function(){var e=parseInt(DerivationList.defaultOptions.font_size);if(e/1.2>12)this.set_font_size(e/1.2)};L.font_larger=function(){var e=parseInt(DerivationList.defaultOptions.font_size);if(e*1.2<160)this.set_font_size(e*1.2)};L.set_font_size=function(e){DerivationList.defaultOptions.font_size=e;r.dls().forEach(function(t){t.options.font_size=e;t.rows.forEach(function(t){t.view.options.font_size=e;t.view.update_all(true);t.updateHandlePos(true)});t.hideAllNodeMappings();t.layoutRows()});t.font_size(new F(e))};var O=function(e){return r.createPath({points:[[e[0],e[1]-m]],color:a==="draw"?g:"white",width:a==="draw"?2*c:2*f})};var A=function(e){this.type="hold";this.subType=e.subType;this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]]};this.fingers=e.fingers.map(function(e){return{pos:[e.pos[0],e.pos[1]]}})};var B=function(e){this.type="touch";this.subType=e.subType;this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]],pos0:[e.finger.pos0[0],e.finger.pos0[1]]};this.fingers=e.fingers.map(function(e){return{pos:[e.pos[0],e.pos[1]]}})};var R=function(e){this.type="drag";this.subType=e.subType;this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]]};this.fingers=e.fingers.map(function(e){return{pos:[e.pos[0],e.pos[1]]}})};var T=function(e){this.type="release";this.subType=e.subType;this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.finger={pos:[e.finger.pos[0],e.finger.pos[1]]};this.fingers=e.fingers.map(function(e){return{pos:[e.pos[0],e.pos[1]]}})};var F=function(e){this.type="fontSize";this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.font_size=e};var S=function(e){this.type="enteredTerm";this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.eq=e.eq;this.dl_id=e.id;this.options=gmath.deepCopy(e)};var H=function(e){this.type="enteredGraph";this.performee=n;this.performee_type="CanvasController";this.time=Date.now();this.graph_id=e};var N=function(){this.type="keyboard";this.performee=n;this.performee_type="CanvasController";this.time=Date.now()};function I(e,t){e.call(t);t.frame(e.node())}function G(){var e=transform_behavior().allow_rotate(false).allow_scale(false).one_finger_drag(false).on("transform",function(){scroll(d3.event.transform.translate[1])});var t=mtouch_events().on("touch",U.bind(this,null)).on("hold",V.bind(this,null)).on("drag",K.bind(this,null)).on("release",j.bind(this,null)).hold_max_dist(5).hold_time(500).call(e);return t}function W(){var e=transform_behavior().allow_rotate(false).allow_scale(false).one_finger_drag(false).on("transform",function(){scroll(d3.event.transform.translate[1])});var t=mtouch_events().on("touch",J.bind(this,null)).on("drag",Z.bind(this,null)).on("release",X.bind(this,null)).hold_max_dist(5).hold_time(500).call(e);return t}var U=function(e){var n=e||d3.event;if(!e&&d3.event){t.touch(new B(gmath.extend(d3.event,{subType:"menu"})))}if(n.fingers.length>1){_=true}};L.menu_touch=U;var V=function(e){if(!D||_)return;var n=e||d3.event;if(!e&&d3.event){t.hold(new A(gmath.extend(d3.event,{subType:"menu"})))}C.setPos(n.finger.pos.slice());C.setVisible(true)};L.menu_hold=V;var K=function(e){var n=e||d3.event;if(!e&&d3.event){t.drag(new R(gmath.extend(d3.event,{subType:"menu"})))}if(_)return;if(C.visible){C.highlight(n.finger.pos.slice())}};L.menu_drag=K;var j=function(e){var n=e||d3.event;if(!e&&d3.event){t.release(new T(gmath.extend(d3.event,{subType:"menu"})))}if(_){if(n.fingers.length===0)_=false;return}if(C&&C.visible){C.performAction(n.finger.pos.slice());C.setVisible(false)}};L.menu_release=j;var J=function(e){var n=e||d3.event;if(!e&&d3.event){t.touch(new B(gmath.extend(d3.event,{subType:"draw"})))}if(n.fingers.length>1){_=true}if(!l||_)return;var i=n.finger.pos0.slice();i[1]-=m;L.cancelHWR(true);w=O(n.finger.pos0);if(a==="draw")P({type:"draw",path:w});if(a==="erase"){d=r.paths_container().append("circle").attr({cx:i[0],cy:i[1],r:f}).style({stroke:"silver",fill:"white"})}};L.draw_touch=J;var Z=function(e){var n=e||d3.event;if(!e&&d3.event){t.drag(new R(gmath.extend(d3.event,{subType:"draw"})))}if(!w||_||!l)return;var i=n.finger.pos.slice();i[1]-=m;w.points.push(i);r.updatePath(w);if(a==="erase")d.attr({cx:i[0],cy:i[1]})};L.draw_drag=Z;var X=function(e){var n=e||d3.event;if(!e&&d3.event){t.release(new T(gmath.extend(d3.event,{subType:"draw"})))}if(_){if(n.fingers.length===0)_=false;return}if(!w)return;if(a==="draw"){if(s&&(!i||!i.visible()))L.scheduleHWR()}else if(a==="erase"){d.remove();Y()}w=null};L.draw_release=X;var Y=function(){var e=r.paths().slice(),t=e[e.length-1],n=[],i=[],o=[];e.forEach(function(e,a){if(e===t)return;var s=f+e.width/2;var l=gm_erase_paths([e.points],t.points,s);if(l.length===0){i.push(e);r.removePath(e)}else{o.push({path:e,points_before:e.points.slice(),points_after:l[0].slice()});e.points=l[0];r.updatePath(e);for(var u=1;u<l.length;u++){var h=r.createPath({points:l[u],color:e.color,width:e.width,oid:e.id});n.push(h)}}});r.removePath(t);P({type:"erase",removed:i,modified:o,added:n})};L.inputDL=function(e){if(o)return;t.keyboard(new N);L.cancelHWR(true);b={pos:[e[0],e[1]-m]};i.caption("Please enter a number, equation, or expression.").latex("").visible(true)};var Q=function(e){i.visible(false);if(e==="")return;b.eq=e;b.id=gmath.uid();t.entered_term(new S(b));var n;try{n=r.createDL(b)}catch(o){console.log(o)}finally{b=null}};var ee=function(){i.visible(false)};L.disableKeyboard=function(e){o=e};function te(){var e=d3.event;e.preventDefault();var t=d3.mouse(svg.node());var n=ne(e.dataTransfer)||re(e.dataTransfer);if(!n){console.log("could not parse drop data",data);return}n=n.replace(/\\end{alignat}/g,"");n=n.replace(/\&\\\,/g,"");n=n.replace(/\\\,/g,"");n=n.replace(/\&/g,"");n=n.replace(/\\begin{alignat}{[0-9]*}/g,"");n=n.replace(/\\\;/g,"");n=n.replace(/[.,\s\\]+$/,"");var i=n.split("\\\\");if(n.length===0)return;try{r.createDLs(i,{pos:t,collapsed_mode:i.length>1})}catch(o){console.log("Could not parse equation!",o)}}function ne(e){var t=e.getData("text/html");var n=document.createElement("div");var r=d3.select(n).html(t).select("img");return r.size()===1?r.attr("alt"):null}function re(e){return e.getData("text/plain")}return d3.rebind(L,t,"on")};return e}();gmath.ui=gmath.ui||{};gmath.ui.CanvasModelView=function(){var e=function(){var e=d3.dispatch("create","update","remove","reset","mode"),t=[],n=[],r,i=[],o=[],a=[],s=null,l,u,h,p,c,f,d,g,v=["transform","inspect","link","draw","erase","delete"],y=0;function m(e){e.dl.draw_mappings_for_nodes([e.node])}function w(e){return;var t=n.indexOf(e);if(t===-1||t===n.length-1)return;n.splice(n.indexOf(e),1);n.push(e);r=l.selectAll(".derivation-list").data(n,function(e){return e.id});r.order()}var b=function(e){s=e;u=s.append("g").attr("id","g_paths");c=s.append("rect").attr("id","background_event_layer").style({fill:"none","pointer-events":"all"}).attr("width","100%").attr("height","100%");h=s.append("g").attr("id","g_graphs");l=s.append("g").attr("id","g_dls");p=s.append("g").attr("id","g_links");f=s.append("rect").attr("id","foreground_event_layer").style({fill:"none","pointer-events":"all",display:"none"}).attr("width","100%").attr("height","100%");d=s.append("g").attr("id","g_messages");return this};b.addDL=function(t){if(n.indexOf(t)!==-1)throw"dl is already in this model";t.canvas_model=b;t.container(l.node());n.push(t);e.create({type:"create",target_type:"dl",target:t});t.events.on("inspect_node",m);r=d3.selectAll(".derivation-list").data(n);t.events.on("hover",w);t.setInteractionMode(v[y]);return t};b.createDL=function(t,i){t.canvas_model=b;var o=new DerivationList(l.node(),t,i);n.push(o);e.create({type:"create",target_type:"dl",target:o});o.events.on("inspect_node",m);r=d3.selectAll(".derivation-list").data(n);o.events.on("hover",w);o.setInteractionMode(v[y]);return o};b.createDLs=function(e,t,n){var r=0;i();function i(o){if(r===e.length){if(n)n()}else{if(o)t.pos[1]+=o.dims.height;var a=gmath.deepCopy(t);a.eq=e[r++];b.createDL(a,i)}}};b.removeDL=function(t){_(n,t);gmath.LinkCoordinator.unlinkDL(t);t.remove();e.remove({type:"remove",target_type:"dl",target:t})};b.addPath=function(n){if(t.indexOf(n)!==-1)throw"path is already in this model";n.setContainer(u);n.init();t.push(n);e.create({type:"create",target_type:"path",target:n});return n};b.createPath=function(n){var r=new gmath.ui.Path(u.node(),n);t.push(r);e.create({type:"create",target_type:"path",target:r});return r};b.updatePath=function(t){t.update();e.update({target_type:"path",target:t})};b.removePath=function(n){_(t,n);n.remove();e.remove({type:"remove",target_type:"path",target:n})};b.createGraph=function(t){t.view=b;var n=new gmath.ui.Graph(h.node(),t);i.push(n);e.create({type:"create",target_type:"graph",target:n});return n};b.removeGraph=function(t){_(i,t);t.remove();e.remove({type:"remove",target_type:"graph",target:t})};b.createLink=function(t,n){var r=(new gmath.ui.Link).a(t).b(n);r(p.node(),b);r.link();o.push(r);e.create({type:"create",target_type:"link",target:r});return r};b.createMessage=function(t){t.view=b;var n=new gmath.ui.Message(d.node(),t);a.push(n);e.create({type:"create",target_type:"message",target:n});return n};b.removeMessage=function(t){if(a.length>0)_(a,t);t.remove();e.remove({type:"remove",target_type:"message",target:t})};var _=function(e,t){var n=e.indexOf(t);if(n===-1)throw"no element "+t;e.splice(n,1)};b.dls=function(t){if(!arguments.length)return n;for(var r=0;r<n.length;r++)n[r].remove();n=t.slice();for(var r=0;r<n.length;r++){n[r].container(l);n[r].init()}e.reset({target_type:"dl",target:n.slice()})};b.graphs=function(){return i};b.graphs=function(e){if(!arguments.length)return i};b.links=function(){return o};b.messages=function(){return a};b.getElementsOfType=function(e){if(e==="graph")return i;if(e==="dl")return n;if(e==="link")return o;if(e==="messages")return a};b.paths=function(n){if(!arguments.length)return t;for(var r=0;r<t.length;r++)t[r].remove();t=n.slice();for(var r=0;r<t.length;r++){t[r].setContainer(u);t[r].init()}e.reset({target_type:"path",target:t.slice()})};b.container=function(){return s};b.background_event_layer=function(e){if(!arguments.length)return c;c=e;return this};b.foreground_event_layer=function(e){if(!arguments.length)return f;f=e;return this};b.display_foreground_event_layer=function(e){if(!arguments.length||e)f.style({display:"inline"});else f.style({display:"none"})};b.dls_container=function(e){if(!arguments.length)return l;l=e;return this};b.paths_container=function(e){if(!arguments.length)return u;u=e;return this};b.graphs_container=function(e){if(!arguments.length)return h;h=e;return this};b.links_container=function(e){if(!arguments.length)return p;p=e;return this};b.messages_container=function(e){if(!arguments.length)return d;d=e;return this};b.size=function(){var e=s.node();while(e.tagName.toLowerCase()!=="svg"&&e.parentNode)e=e.parentNode;var t=e.getBoundingClientRect();return{width:t.width,height:t.height}};b.interactionMode=function(t){if(arguments.length===0)return v[y];if(t==="inspect"&&v[y]!=="inspect"||t!=="inspect"&&v[y]==="inspect"){b.updateStyleOfNodes(t)}y=v.indexOf(t);s.select("rect").style("fill",t==="delete"?"whitesmoke":"none");n.forEach(function(e){e.setInteractionMode(t)});i.forEach(function(e){e.setInteractionMode(t)});e.mode({type:"mode",mode:t});return this};b.switchMode=function(){b.interactionMode(v[++y%v.length]);e.mode({type:"mode",mode:v[y]})};b.updateStyleOfNodes=function(e){var t=b.dls();t.forEach(function(t){t.rows.forEach(function(t){if(!t.view)return;if(e==="inspect"){t.view.options.visualize_scrubbable_nodes=true}else{t.view.options.visualize_scrubbable_nodes=false}t.view.update_existing("normal")})})};return d3.rebind(b,e,"on")};return e}();gmath.ui=gmath.ui||{};gmath.ui.CanvasFactory=function(){var e=function(t,n){this.container=d3.select(t);this.options=gmath.object.merged(gmath.deepCopy(e.defaultOptions),n);this.events=d3.dispatch("button");this.model=gmath.ui.CanvasModelView();this.controller=gmath.ui.CanvasController(this.model).drawing(this.options.drawing).hwr(this.options.hwr).use_keyboard(this.options.use_keyboard).use_hold_menu(this.options.use_hold_menu);this.init();if(this.options.initialState){gmath.ui.CanvasParser.parse(this,this.options.initialState)}};e.prototype.serialize=function(){return JSON.stringify(this.model.dls().concat(this.model.graphs()))};e.prototype.init=function(){this.id=gmath.uid();this.tools=this.container.append("div").attr({"class":"btn-toolbar",role:"toolbar"}).style({"margin-bottom":"10px"});if(this.options.mode_btns)this.appendButtonGroup(this.options.mode_btns,this.onButton);if(this.options.undo_btn||this.options.redo_btn){var e=[];if(this.options.undo_btn)e.push(this.options.undo_btn);if(this.options.redo_btn)e.push(this.options.redo_btn);this.appendButtonGroup(e,this.onButton)}if(this.options.font_smaller_btn&&this.options.font_larger_btn){var t=[];t.push(this.options.font_smaller_btn);t.push(this.options.font_larger_btn);this.appendButtonGroup(t,this.onButton)}if(this.options.help_btn){var n=[];n.push(this.options.help_btn);this.appendButtonGroup(n,this.onButton)}if(this.options.hwr&&this.options.hwr_btn){var r=this.appendButtonGroup([this.options.hwr_btn],this.onButton);this.controller.on("start_hwr",function(){r.classed("btn-info",true)}).on("stop_hwr",function(){r.classed("btn-info",false)})}if(this.options.fullscreen_btn){this.appendButtonGroup([this.options.fullscreen_btn],this.onButton)}var i=this.tools.node().getBoundingClientRect().height;if(i===0)i={xs:46,sm:64}[this.options.btn_size]||72;this.svg=this.options.toolbar_pos==="top"?this.container.append("svg"):this.container.insert("svg","div.btn-toolbar");this.svg.style("width",this.options.width).style("height","calc("+this.options.height+" - "+(i+10)+"px)").style("display","block");this.svgg=this.svg.append("g");this.svgg.call(this.model).call(this.controller)};e.prototype.onButton=function(e){this.events.button({button:{label:e.label,state:e.state,type:e.type},time:Date.now()});this.updateButton(e);if(e.label==="undo")this.controller.undo();if(e.label==="redo")this.controller.redo();if(e.label==="HWR")this.controller.hwr(e.state);if(e.label==="transform")this.model.interactionMode("transform");if(e.label==="scrub")this.model.interactionMode("inspect");if(e.label==="delete")this.model.interactionMode("delete");if(e.label==="draw")this.model.interactionMode("draw");if(e.label==="erase")this.model.interactionMode("erase");if(e.label==="help")this.help();if(e.label==="fullscreen"&&e.state===true)this.launchFullScreen();if(e.label==="fullscreen"&&e.state===false)this.cancelFullScreen();if(!(e.label==="HWR"&&e.state===true))this.controller.cancelHWR();if(e.label==="larger")this.controller.font_larger();if(e.label==="smaller")this.controller.font_smaller()};e.prototype.launchFullScreen=function(e){e=e||document.body;if(e.requestFullscreen)e.requestFullscreen();else if(e.mozRequestFullScreen)e.mozRequestFullScreen();else if(e.webkitRequestFullscreen)e.webkitRequestFullscreen();else if(e.msRequestFullscreen)e.msRequestFullscreen();
};e.prototype.help=function(){var e=window.open("http://graspablemath.com/unstable/tutorial/index.html","_blank");e.focus()};e.prototype.cancelFullScreen=function(){if(document.exitFullscreen)document.exitFullscreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else if(document.webkitExitFullscreen)document.webkitExitFullscreen();else if(document.msExitFullscreen)document.msExitFullscreen()};e.prototype.updateButton=function(e){this.tools.select("button#"+e.label).datum(e).each(function(e){if(e.type==="toggle"){e.state=!e.state;d3.select(this).classed("active",e.state)}else if(e.type==="radio"){var t=this;d3.select(this.parentNode).selectAll("button").each(function(e){e.state=t===this}).classed("active",function(e){return e.state})}})};e.prototype.appendButtonElement=function(e,t){var n=this;var r=e.append("button").attr("id",function(e){return e.label}).attr({type:"button","class":"btn btn-default"}).classed("btn-xs",n.options.btn_size==="xs").classed("btn-sm",n.options.btn_size==="sm").classed("active",function(e){return e.state}).style("min-width","4em");if(t)r.on("click",t.bind(this));if(this.options.display_icons){var i=r.filter(function(e){return e.icon});i.append("i").attr("class",function(e){return e.icon}).style({color:"#555","font-size":"1.2em","line-height":"1.7em"}).style("transform",function(e){return e.flip==="x"?"rotateX(180deg)":e.flip==="y"?"rotateY(180deg)":e.flip==="xy"?"rotateZ(180deg)":null});i.append("br")}if(this.options.display_labels){r.append("span").text(function(e){return e.label}).style("color","#555")}};e.prototype.appendButtonGroup=function(e,t){var n=this.tools.append("div").attr({"class":"btn-group",role:e[0].group}).classed("pull-right",e[0].pull_right).selectAll("button").data(e);n.enter().call(this.appendButtonElement.bind(this),t);return n};e.defaultOptions={width:"100%",height:"100%",toolbar_pos:"top",undo_btn:{type:"push",label:"undo",icon:"glyphicon glyphicon-chevron-left"},redo_btn:{type:"push",label:"redo",icon:"glyphicon glyphicon-chevron-right"},font_smaller_btn:{type:"push",label:"smaller",icon:"glyphicon glyphicon-text-size",flip:"y"},font_larger_btn:{type:"push",label:"larger",icon:"glyphicon glyphicon-text-size"},help_btn:{type:"push",label:"help",pull_right:true,icon:"glyphicon glyphicon-education"},hwr_btn:{type:"toggle",label:"HWR",pull_right:true,state:true,icon:"glyphicon glyphicon-font"},fullscreen_btn:{type:"toggle",label:"fullscreen",pull_right:true,state:false,icon:"glyphicon glyphicon-resize-full"},hwr:true,use_keyboard:true,use_hold_menu:true,drawing:true,display_icons:true,display_labels:true,btn_size:"sm",mode_btns:[{type:"radio",group:"mode",state:true,label:"transform",icon:"glyphicon glyphicon-random"},{type:"radio",group:"mode",state:false,label:"scrub",icon:"glyphicon glyphicon-resize-vertical"},{type:"radio",group:"draw",state:false,label:"draw",icon:"glyphicon glyphicon-pencil"},{type:"radio",group:"draw",state:false,label:"erase",icon:"glyphicon glyphicon-erase"},{type:"radio",group:"mode",state:false,label:"delete",icon:"glyphicon glyphicon-trash"}]};return e}();gmath.ui=gmath.ui||{};gmath.ui.Keyboard=function(){var e=function(){var e="m -5.708,-15.7 20.344,0 c 3.669696,0 6.624,2.954304 6.624,6.624 l 0,17.752 c 0,3.669696 -2.954304,6.624 -6.624,6.624 l -20.488,0 -15.408,-15.48 zM -2.18,-6.948 11.716,6.948M -2.18,6.948 11.716,-6.948";var t="M 13.7,16.5 -13.7,16.5 0,-16.5 z";var n=d3.dispatch("done","cancel","change"),r="",i=false,o,a,s=null,l=null,u=null,h=900,p,c,f,d,g,v,y="center",m=null;var w=function(){k();v=mtouch_events().on("touch",q).on("release",z).on("hold",D).hold_time(750);x();M();if(r!="")o.mathquill("write",r);return this};function b(e){n[e](o.mathquill("latex"))}w.width=function(e){if(arguments.length==0)return h;h=e;if(s)M();return this};w.latex=function(e){if(arguments.length==0){if(o)r=o.mathquill("latex");return r}else{r=e;if(o)o.mathquill("latex",e);return this}};w.visible=function(e){if(arguments.length==0)return i;if(i==e)return this;i=e;if(!s)return this;if(i){s.style("display","block");a.focus()}else s.style("display","none");return this};w.position=function(e){if(arguments.length==0)return y;if(y==e)return this;y=e;if(!s)return this;s.call(O,y);return this};w.caption=function(e){if(arguments.length===0)return m;m=e;if(!u)return this;if(!m)u.style("display","none");else{u.text(e);u.style("display",null)}return this};var _=function(){var e=11*130+10*10+2*10+2*10,t=3*110+20+10+2*10+2*10,n=h/e;c=130*n;d=10*n;f=110*n;p=t*n};var k=function(){g=[];g.push({name:"Cancel",type:"event",event:"cancel",col:0,row:0,cols:2});g.formula={type:"formula",col:2,row:0,cols:6};g.push({type:"backspace",col:8,row:0});g.push({name:"Done",type:"event",event:"done",col:9,row:0,cols:2});g.push({name:"0",type:"key",col:0,row:1});g.push({name:"1",type:"key",col:1,row:1});g.push({name:"2",type:"key",col:2,row:1});g.push({name:"3",type:"key",col:3,row:1});g.push({name:"4",type:"key",col:4,row:1});g.push({name:"+",type:"key",col:5,row:1});g.push({name:"*",type:"key",val:"*",col:6,row:1,dy:"0.3em"});g.push({name:"(",type:"key",col:7,row:1});g.push({name:")",type:"key",col:8,row:1});g.push({name:"n",type:"key",col:9,row:1});g.push({name:"^",type:"key",col:10,row:1});g.push({name:"5",type:"key",col:0,row:2});g.push({name:"6",type:"key",col:1,row:2});g.push({name:"7",type:"key",col:2,row:2});g.push({name:"8",type:"key",col:3,row:2});g.push({name:"9",type:"key",col:4,row:2});g.push({name:"−",type:"key",val:"-",col:5,row:2});g.push({name:"÷",type:"key",val:"/",col:6,row:2});g.push({name:"=",type:"key",col:7,row:2});g.push({type:"arrow",dir:"left",col:8,row:2,cols:1,rows:.5});g.push({type:"arrow",dir:"up",col:9,row:1.5,cols:1,rows:.5});g.push({type:"arrow",dir:"down",col:9,row:2,cols:1,rows:.5});g.push({type:"arrow",dir:"right",col:10,row:2,cols:1,rows:.5})};var x=function(){s=d3.select("body").append("div").style({position:"fixed",bottom:0,"z-index":1e4}).style("display",i?"block":"none");u=s.append("div").attr("id","caption").style({position:"relative",background:"rgb(244, 244, 244)",padding:"12px",border:"1px solid silver","border-radius":"7.6px 7.6px 0 0","border-bottom":"none",width:"80%",margin:"auto","font-family":"HelveticaNeue-Light",color:"#666","font-size":"17px","text-align":"center",display:m?null:"none"}).text(m);l=s.append("div").classed("keyboard",true);o=l.append("div").attr("id","formula").datum(g.formula).append("div").attr("id","mq_div").append("span").attr("id","mq_span");o=$(o.node()).mathquill("editable");a=o.find("textarea");if(i)a.focus();d3.select(a[0]).on("keyup",function(){if(d3.event.keyCode===13)b("done")});C();var e=l.selectAll(".key").data(g).enter().append("div").classed("key",true).call(v);e.filter(function(e){return e.type=="backspace"}).classed("backspace-key",true).append("svg").append("path");e.filter(function(e){return e.type=="arrow"}).classed("arrow-key",true).append("svg").append("path");e.filter(function(e){return e.name}).classed("normal-key",true).append("span")};var M=function(){_();s.call(O,y);l.style("height",p+"px").style("width",h+"px").style({bottom:0,background:"#DDD",padding:0,"text-align":"center",border:"1px solid silver","border-radius":d*1.5+"px "+d*1.5+"px 0 0","border-bottom":"none"}).select("#formula").style("border",d+"px solid #DDD").style("border-radius",d+"px").call(P,d).select("#mq_div").style("border-radius",d+"px").style("width",function(e){return(e.cols||1)*c+((e.cols||1)-1)*d+"px"}).call(E).select("#mq_span").style("box-shadow","none").style("-webkit-box-shadow","none").style("-moz-box-shadow","none").style("margin-top",d).style("font-size",f/2+f/10+"px").style("padding-top",3*d-2+"px").style("padding-bottom",2*d+"px").style("border","none").style("min-height",function(e){return(e.rows||1)*f+((e.rows||1)-1)*d-5*d+"px"}).style("width","100%");l.selectAll(".key").call(P).call(L).call(E);l.selectAll(".backspace-key path").attr("d",e).style("stroke","black").style("stroke-width","1.2").style("fill","none").attr("transform","translate("+c/2+","+f/2+")scale("+.12*d+")");l.selectAll(".arrow-key path").attr("d",t).style("stroke","black").style("stroke-linejoin","round").style("stroke-width",3).style("fill","none").attr("transform",function(e){var t={left:-90,up:0,right:90,down:180}[e.dir];return"translate("+c/2+","+f/4+")scale("+.05*d+")rotate("+t+")"});l.selectAll(".normal-key span").text(function(e){return e.name}).style("line-height",f+"px").filter(function(e){return e.dy}).style("display","inline-block").style("margin-top",function(e){return e.dy})};var C=function(){if(/iPhone|iPod|iPad|Android|BlackBerry/.test(navigator.userAgent))l.select(".textarea textarea").attr("readonly","readonly")};var q=function(e){d3.select(this).style("background","gray");if(e.type==="formula")return;a.focus();if(e.type==="key"){var t=e.val||e.name;var n=t.charCodeAt(0);a.val(t);a.trigger($.Event("keydown",{which:n}));a.trigger($.Event("keypress",{which:n}));b("change")}else if(e.type==="backspace"){a.trigger($.Event("keydown",{which:8}));b("change")}else if(e.type==="event"){b(e.event)}else if(e.type==="arrow"){var n={left:37,up:38,right:39,down:40}[e.dir];a.trigger($.Event("keydown",{which:n}));b("change")}};var z=function(e){d3.select(this).style("background",e.type=="key"||e.type=="formula"?"white":"silver")};var D=function(e){if(e.type!=="backspace")return;o.mathquill("latex","");a.focus()};var P=function(e,t){t=t||0;e.style("position","absolute").style("left",function(e){return e.col*(c+d)+2*d-t+"px"}).style("bottom",function(e){return(2-e.row)*(f+d)+(e.row==0?d:0)+2*d-t+"px"})};var L=function(e,t,n){t=t||0;n=n||0;e.style("width",function(e){return(e.cols||1)*c+((e.cols||1)-1)*d-2*t+"px"}).style("height",function(e){return(e.rows||1)*f+((e.rows||1)-1)*d-2*n+"px"})};var E=function(e){e.style("border-radius",d+"px").style("font-size",f/2+"px").style("background",function(e){return e.type=="key"||e.type=="formula"?"white":"silver"}).style("box-shadow","#888 0px 1px 0px").style("font-family","'HelveticaNeue-UltraLight', 'Helvetica Neue UltraLight', 'Helvetica Neue', Arial, Helvetica, sans-serif").style("font-weight",100).style("border","none").style("padding",0).style("-webkit-user-select","none").style("-khtml-user-select","none").style("-moz-user-select","none").style("-ms-user-select","none").style("user-select","none").style("cursor","pointer")};var O=function(e,t){if(t==="center"){e.style("margin-left",-h/2+"px");e.style("left","50%");e.style("right",null)}else if(t==="left"){e.style("margin-left",0);e.style("left",0);e.style("right",null)}else if(t==="right"){e.style("margin-left",0);e.style("left",null);e.style("right",0)}else{e.style("margin-left",-h/2+"px");e.style("left",t);e.style("right",null)}};return d3.rebind(w,n,"on")};return e}();SVGPlayButton=function(){var e=d3.dispatch("click");var t,n,r,i,o,a=false;var s=function(e){t=e;s.init();return s};s.hidden=function(e){if(arguments.length===0)return a;a=e;if(i)i.style("display",a?"none":null);if(o)o.attr("opacity",0);return this};s.remove=function(){if(r)r.remove()};s.init=function(){n=t.node().getBoundingClientRect();r=t.append("svg").attr("id","button").attr("width","100%").attr("height","100%").attr("cursor","pointer");i=r.append("g").style("display",a?"none":null).attr("transform","translate("+[n.width/2,n.height/2]+")");i.append("rect").attr({x:-n.width/2,y:-n.height/2,width:n.width,height:n.height}).attr({fill:"black",opacity:.1});i.append("circle").attr({r:"35px"}).attr({fill:"#666",stroke:"white","stroke-width":"4px","fill-opacity":.6});i.append("circle").attr({r:"37px"}).attr({fill:"none",stroke:"silver","stroke-width":1.5});i.append("path").attr("d","M0,0 L0,1 L0.8,0.5 Z").attr("transform","scale(40)translate(-0.3,-0.5)").attr("fill","white");o=r.append("rect").classed("overlay",true).attr({width:n.width,height:n.height}).attr({fill:"black",opacity:0}).attr("pointer-events","all").on("mouseover",function(){o.attr("opacity",a?0:.1)}).on("mouseout",function(){o.attr("opacity",0)}).on("click",function(){if(!a)e.click()})};return d3.rebind(s,e,"on")};
